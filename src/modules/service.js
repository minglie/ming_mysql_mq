var M=require("ming_node")var Db=require("../modules/ming_mysql")var request = require("request");var options = { method: 'POST',    url: 'http://localhost:11111/addMessage',    timeout: 3000,    headers:        { 'Postman-Token': '38f0bf98-d9bf-4256-9a1f-1562d88f3731',            'cache-control': 'no-cache',            'Content-Type': 'application/json' },    body: { topic: 'topic01', body: 'ok' },    json: true };global.applicationConfig=M.getObjByFile("../../applicationConfig.json");var service={};//添加消息入库service.addMessage=async function (message) {  let sql=`insert into ming_mysql_mq_message(topic,ip,body,request_time,status) values (    '${message.topic}','${message.ip}','${message.body}',now(),0 )`;     let a=await Db.doSql(sql)     return a;};//获取topic的订阅者service.getConsumersByTopic=function (topic) {    let r=applicationConfig.ming_mysql_mq_config.filter(u=>u.topic==topic);    if(r.length>0){        return r[0].consumer;    }else {        return null;    }};service.sendMessage=  function (message,url) {    options.url=url;    options.body=message;    var promise = new Promise(function(reslove,reject){        request(options, function (error, response, body) {            if(response && response.statusCode==200 ){                reslove(true);            }else {                reslove(false);            }        });    })    return promise;}//分发消息service.dispacherMessage=async function (message) {    let topic=message.topic;    let consumers=service.getConsumersByTopic(topic)    if(consumers){        consumers=JSON.parse(consumers)        for (let i=0;i<consumers.length;i++){            let r=await service.sendMessage(message,consumers[i])            M.log("-->"+consumers[i],"<--"+r)            return r;        }    }else {        return false;    }}//添加消息入库service.reloadMessageConfig=async function () {    let sql=`select * from ming_mysql_mq_config`;    let a=await Db.doSql(sql);    global.applicationConfig.ming_mysql_mq_config=a;    return;};if(0)+async function(){  a= await service.sendMessage({body:44},"http://192.168.1.101:11112/topic01Listener")    console.log(a)}();module.exports=service;